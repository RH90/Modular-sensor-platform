C51 COMPILER V9.53.0.0   POWER                                                             04/24/2018 12:57:54 PAGE 1   


C51 COMPILER V9.53.0.0, COMPILATION OF MODULE POWER
OBJECT MODULE PLACED IN .\src\power.OBJ
COMPILER INVOKED BY: c:\SiliconLabs\SimplicityStudio\v4\developer\toolchains\keil_8051\9.53\BIN\C51.exe C:\Users\Rilind\
                    -Desktop\System_project\Exam_Project\Exam_Project_2\F99x-98x_SleepMode_PortMatchWake\src\power.c OMF2 SMALL DEBUG OBJECTE
                    -XTEND ROM(LARGE) WARNINGLEVEL(2) FLOATFUZZY(3) OPTIMIZE(8,SPEED) DEFINE(DEBUG=1) INTVECTOR(0X0000) INTPROMOTE INCDIR(C:/
                    -Users/Rilind/Desktop/System_project/Exam_Project/Exam_Project_2/F99x-98x_SleepMode_PortMatchWake/inc;C:/SiliconLabs/Simp
                    -licityStudio/v4/developer/sdks/8051/v4.1.1//Device/shared/si8051base;C:/SiliconLabs/SimplicityStudio/v4/developer/sdks/8
                    -051/v4.1.1//Device/C8051F990/inc) PRINT(.\src\power.lst) COND PAGEWIDTH(120) PAGELENGTH(65) OBJECT(.\src\power.OBJ)

line level    source

   1          //-----------------------------------------------------------------------------
   2          // power.c
   3          //-----------------------------------------------------------------------------
   4          // Copyright 2014 Silicon Laboratories, Inc.
   5          // http://developer.silabs.com/legal/version/v11/Silicon_Labs_Software_License_Agreement.txt
   6          //
   7          // Program Description:
   8          //
   9          // Driver for the power management function.
  10          //
  11          // Target:         C8051F99x-C8051F98x
  12          // Tool chain:     Generic
  13          // Command Line:   None
  14          //
  15          // Release 1.0
  16          //    - Initial Revision (FB)
  17          //    - 19 MAY 2010
  18          //
  19          
  20          //-----------------------------------------------------------------------------
  21          // Includes
  22          //-----------------------------------------------------------------------------
  23          #include "SI_C8051F990_Register_Enums.h"
  24          #include "C8051F990_lib.h"
  25          
  26          //-----------------------------------------------------------------------------
  27          // Global Variables
  28          //-----------------------------------------------------------------------------
  29          
  30          // Variables used for the RTC interface
  31          U8 PMU0CF_Local;                       // Holds the desired Wake-up sources
  32           
  33          // Define Wake-Up Flags
  34          U8 RTC_Alarm;
  35          U8 RTC_Failure;
  36          U8 Comparator_Wakeup;
  37          U8 Port_Match_Wakeup;
  38          
  39          //-----------------------------------------------------------------------------
  40          // Function PROTOTYPES
  41          //-----------------------------------------------------------------------------
  42          void LPM(U8 mode);
  43          void LPM_Init(void);
  44          void LPM_Enable_Wakeup (U8 wakeup);
  45          void LPM_Disable_Wakeup (U8 wakeup);
  46          
  47          //-----------------------------------------------------------------------------
  48          // LPM_Init ()
  49          //-----------------------------------------------------------------------------
  50          //
  51          // Return Value : None
C51 COMPILER V9.53.0.0   POWER                                                             04/24/2018 12:57:54 PAGE 2   

  52          // Parameters   : None
  53          //
  54          // This function will initialize the low power functionality
  55          //
  56          //-----------------------------------------------------------------------------
  57          void LPM_Init (void)
  58          {
  59   1        PMU0CF = CLEAR;
  60   1        PMU0CF_Local = 0;
  61   1        RTC_Alarm = 0;
  62   1        RTC_Failure = 0;
  63   1        Comparator_Wakeup = 0;
  64   1        Port_Match_Wakeup = 0;
  65   1        P2MDOUT |= 0x01;
  66   1      }
  67          
  68          //-----------------------------------------------------------------------------
  69          // LPM_Enable_Wakeup ()
  70          //-----------------------------------------------------------------------------
  71          //
  72          // Return Value : None
  73          // Parameters   : None
  74          //
  75          // This function will enable wakeup sources
  76          //
  77          //-----------------------------------------------------------------------------
  78          void LPM_Enable_Wakeup (U8 wakeup)
  79          {
  80   1        PMU0CF_Local |= (wakeup & (RTC | PORT_MATCH | COMPARATOR));
  81   1      }
  82          
  83          //-----------------------------------------------------------------------------
  84          // LPM_Disable_Wakeup ()
  85          //-----------------------------------------------------------------------------
  86          //
  87          // Return Value : None
  88          // Parameters   : None
  89          //
  90          // This function will disable wakeup sources
  91          //
  92          //-----------------------------------------------------------------------------
  93          void LPM_Disable_Wakeup (U8 wakeup)
  94          {
  95   1        PMU0CF_Local &= ~(wakeup & (RTC | PORT_MATCH | COMPARATOR));
  96   1      }
  97          
  98          //-----------------------------------------------------------------------------
  99          // LPM
 100          //-----------------------------------------------------------------------------
 101          //
 102          // Return Value : none
 103          // Parameters   : 1) U8 mode -- can be SLEEP or SUSPEND
 104          //
 105          // This function places the device in a low power mode
 106          //
 107          //-----------------------------------------------------------------------------
 108          void LPM(U8 mode)
 109          {
 110   1         U8 b;
 111   1         U8 CLKSEL_save;
 112   1         U8 EA_save;
 113   1         U8 PMU0CF_snapshot;
 114   1         U8 RTC0CN_snapshot;
C51 COMPILER V9.53.0.0   POWER                                                             04/24/2018 12:57:54 PAGE 3   

 115   1         
 116   1         // Save current interrupt state and disable interrupts 
 117   1         EA_save = IE_EA;
 118   1         IE_EA = 0;
 119   1         
 120   1         // Save current system clock selection and select the low power oscillator
 121   1         // divided by 2 as the system clock
 122   1         CLKSEL_save = CLKSEL;
 123   1         CLKSEL = 0x14;
 124   1         
 125   1         // Enable the Flash read one-shot timer   
 126   1         FLSCL &= ~BYPASS;                   // Clear the one-shot bypass bit
 127   1         FLWR  =   NON_ZERO;                 // Write a "dummy" value to FLWR
 128   1         
 129   1         // Verify that the system clock setting has been applied
 130   1         while(!(CLKSEL & 0x80));            // Wait until CLKRDY -> 1
 131   1         
 132   1         //----------------------------------
 133   1         // ~~~ Device in Low Power Mode ~~~
 134   1         //
 135   1             PMU0CF = (mode | PMU0CF_Local);
 136   1         //
 137   1         // ~~~   Device is now Awake    ~~~
 138   1         //----------------------------------
 139   1         
 140   1         // Restore the System Clock
 141   1         CLKSEL = CLKSEL_save;
 142   1         
 143   1         // Disable (Bypass) the Flash Read one-shot timer if the system clock
 144   1         // frequency is higher than 10 MHz
 145   1         if(SYSCLK > 10000000)
 146   1         {
 147   2            FLSCL |= BYPASS;                 // Set the one-shot bypass bit                     
 148   2         }
 149   1        
 150   1         // Capture the wake-up source and clear all wake-up source flags   
 151   1         PMU0CF_snapshot = PMU0CF;
 152   1         PMU0CF = CLEAR;
 153   1      
 154   1         // Capture RTC events that occured while PMU0CF was being cleared
 155   1         RTC0CN_snapshot = RTC_Read(RTC0CN); 
 156   1      
 157   1         // If an RTC Alarm occured while PMU0CF was being cleared, clear 
 158   1         // the PCU0CF flag again   
 159   1         if(RTC0CN_snapshot & (ALRM) && ((PMU0CF_snapshot & RTCAWK) == 0))
 160   1         {
 161   2            PMU0CF_snapshot |= PMU0CF;
 162   2            PMU0CF = CLEAR;
 163   2         }
 164   1      
 165   1         //----------------------------------
 166   1         // Decode Wake-Up Sources
 167   1         //----------------------------------
 168   1      
 169   1         // Check for an RTC Alarm
 170   1         if((PMU0CF_snapshot & RTCAWK) || (RTC0CN_snapshot & ALRM))
 171   1         {
 172   2            RTC_Alarm = 1;
 173   2         }
 174   1         // Check for an RTC Clock Failure
 175   1         if((PMU0CF_snapshot & RTCFWK) || (RTC0CN_snapshot & OSCFAIL))
 176   1         {
 177   2            RTC_Failure = 1;  
C51 COMPILER V9.53.0.0   POWER                                                             04/24/2018 12:57:54 PAGE 4   

 178   2         }
 179   1         // Check for a Port Match Wakeup
 180   1         if(PMU0CF_snapshot & PMATWK)
 181   1         {
 182   2            Port_Match_Wakeup = 1;  
 183   2         }
 184   1         // Check for a Comparator Wakeup
 185   1         if(PMU0CF_snapshot & CPT0WK)
 186   1         {
 187   2            Comparator_Wakeup = 1;  
 188   2         }
 189   1         
 190   1         // Restore Interrupt State
 191   1         IE_EA = EA_save;
 192   1         
 193   1         // Check for a reset pin Wakeup
 194   1         if(PMU0CF_snapshot & RSTWK)
 195   1         {
 196   2            // Delay 15uS per datasheet recommendation
 197   2            for(b = 255; b > 0; b--);
 198   2         }
 199   1          
 200   1      }               


MODULE INFORMATION:   STATIC OVERLAYABLE
   CODE SIZE        =    148    ----
   CONSTANT SIZE    =   ----    ----
   XDATA SIZE       =   ----    ----
   PDATA SIZE       =   ----    ----
   DATA SIZE        =      5       2
   IDATA SIZE       =   ----    ----
   BIT SIZE         =   ----    ----
   EDATA SIZE       =   ----    ----
   HDATA SIZE       =   ----    ----
   XDATA CONST SIZE =   ----    ----
   FAR CONST SIZE   =   ----    ----
END OF MODULE INFORMATION.


C51 COMPILATION COMPLETE.  0 WARNING(S),  0 ERROR(S)
